import eslint from "@eslint/js";
import nPlugin from "eslint-plugin-n";
import { defineConfig } from "eslint/config";
import globals from "globals";
import tseslint from "typescript-eslint";

/**
 * @param {object} options
 * @param {boolean|object} [options.projectService]
 * @param {string} options.tsconfigRootDir
 * @returns {import('eslint').Linter.Config[]}
 */
export function defineBaseConfig(options) {
  const { projectService = true, tsconfigRootDir } = options;

  return defineConfig(
    eslint.configs.recommended,
    nPlugin.configs["flat/recommended"],
    tseslint.configs.recommendedTypeChecked,
    {
      languageOptions: {
        // we only run in node, not browser
        globals: globals.node,
        // required to use tseslint.configs.recommendedTypeChecked
        parserOptions: {
          // Defaults to "true", which is the minimum required to use tseslint.configs.recommendedTypeChecked
          // Can be overridden by caller, by setting to a config object
          projectService,
          // Must be set by caller, since this should point to the root directory of the project being analyzed
          tsconfigRootDir,
        },
      },
    },
    {
      ignores: [
        // generated by `vitest --coverage`
        "coverage/**",
      ],
    },
    {
      rules: {
        // fetch, Response and import.meta.dirname are available in the minimum engine version (>=20.11.0),
        // but eslint-plugin-n flags them due to gaps in backport ranges or experimental status.
        "n/no-unsupported-features/node-builtins": [
          "error",
          { ignores: ["fetch", "Response", "import.meta.dirname"] },
        ],
      },
    },
    {
      // Allow devDependency and transitive imports in test, config, perf, and cmd files
      files: ["**/*.config.js", "**/*.test.js", "**/test/**/*.js", "**/perf/**/*.js"],
      rules: {
        "n/no-unpublished-import": "off",
        "n/no-extraneous-import": "off",
      },
    },
    {
      // CLI scripts in cmd/ directories intentionally have shebangs even when not listed in bin
      files: ["**/cmd/**/*.js"],
      rules: {
        "n/hashbang": "off",
        "n/no-process-exit": "off",
      },
    },
  );
}
