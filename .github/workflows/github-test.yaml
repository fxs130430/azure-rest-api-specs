name: GitHub Actions - Test

on:
  push:
    branches:
      - main
    paths:
      - .github/**
  pull_request:
    paths:
      - .github/**
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    strategy:
      matrix:
        folder: [.github, .github/shared]
        os: [ubuntu, windows]

    runs-on: ${{ fromJSON('{"ubuntu":"ubuntu-24.04", "windows":"windows-2022"}')[matrix.os] }}

    defaults:
      run:
        working-directory: ./${{ matrix.folder }}

    env:
      POST_SUMMARY: ${{ matrix.folder == '.github' && matrix.os == 'ubuntu' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github

      - name: Install dev deps
        uses: ./.github/actions/setup-node-install-deps
        with:
          # actions/github-script@v8 uses Node 24
          node-version: 24.x
          working-directory: ./${{ matrix.folder }}

      - name: npm run test:ci
        shell: bash
        run: |
          set +e
          npm run test:ci 2>&1 | tee /tmp/vitest-output.txt
          TEST_EXIT=$?
          set -e

          if [ "$POST_SUMMARY" = "true" ]; then
            {
              echo '## Vitest Summary'
              echo '```text'
              awk '/Test Files/{flag=1} flag{print} /Duration/{flag=0}' /tmp/vitest-output.txt | sed 's/\x1b\[[0-9;]*m//g'
              echo '```'
              echo '## Coverage Report'
              echo '```text'
              awk '/^-+\|/{found=1} found{print}' /tmp/vitest-output.txt | sed 's/\x1b\[[0-9;]*m//g'
              echo '```'
              echo '<details>'
              echo '<summary>üìã Full Test Log (click to expand)</summary>'
              echo ''
              echo '```text'
              sed 's/\x1b\[[0-9;]*m//g' /tmp/vitest-output.txt
              echo '```'
              echo '</details>'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          exit $TEST_EXIT

      - name: npm run lint
        shell: bash
        run: |
          set +e
          npm run lint 2>&1 | tee /tmp/lint-output.txt
          LINT_EXIT=$?
          set -e

          if [ "$POST_SUMMARY" = "true" ]; then
            {
              echo '<details>'
              echo '<summary>üîç Lint Output (click to expand)</summary>'
              echo ''
              echo '```text'
              sed 's/\x1b\[[0-9;]*m//g' /tmp/lint-output.txt
              echo '```'
              echo '</details>'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          exit $LINT_EXIT

      - name: npm run format:check
        shell: bash
        run: |
          set +e
          npm run format:check 2>&1 | tee /tmp/format-output.txt
          FORMAT_EXIT=$?
          set -e

          if [ "$POST_SUMMARY" = "true" ]; then
            {
              echo '<details>'
              echo '<summary>üìù Format Check (click to expand)</summary>'
              echo ''
              echo '```text'
              sed 's/\x1b\[[0-9;]*m//g' /tmp/format-output.txt
              echo '```'
              echo '</details>'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          exit $FORMAT_EXIT

      # Content copied from https://raw.githubusercontent.com/rhysd/actionlint/2ab3a12c7848f6c15faca9a92612ef4261d0e370/.github/actionlint-matcher.json
      - if: matrix.folder == '.github' && matrix.os == 'ubuntu'
        name: actionlint
        shell: bash
        working-directory: .
        run: |
          echo "::add-matcher::.github/matchers/actionlint.json"
          curl -sL "https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz" | tar xz -C /tmp actionlint
          set +e
          /tmp/actionlint -color -verbose 2>&1 | tee /tmp/actionlint-output.txt
          ACTIONLINT_EXIT=$?
          set -e

          {
            echo '<details>'
            echo '<summary>üîß ActionLint (click to expand)</summary>'
            echo ''
            echo '```text'
            sed 's/\x1b\[[0-9;]*m//g' /tmp/actionlint-output.txt
            echo '```'
            echo '</details>'
          } >> "$GITHUB_STEP_SUMMARY"

          exit $ACTIONLINT_EXIT

      - if: matrix.folder == '.github'
        name: Install dependencies for github-script actions
        uses: ./.github/actions/install-deps-github-script

      - if: matrix.folder == '.github'
        name: Verify all modules are importable
        uses: actions/github-script@v8
        with:
          script: |
            const { join } = await import("path");
            const { pathToFileURL } = await import("url");
            const fullPath = join(process.env.GITHUB_WORKSPACE, ".github", "workflows", "src", "github-test.js");
            const { default: importAllModules } = await import(pathToFileURL(fullPath).href);
            await importAllModules({ core });

      - if: matrix.folder == '.github' && matrix.os == 'ubuntu'
        name: Post verify modules summary
        shell: bash
        run: |
          {
            echo '<details>'
            echo '<summary>üì¶ Verify Modules Importable (click to expand)</summary>'
            echo ''
            echo '‚úÖ All modules verified importable'
            echo '</details>'
          } >> "$GITHUB_STEP_SUMMARY"
